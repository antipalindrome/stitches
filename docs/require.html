<!DOCTYPE html>  <html> <head>   <title>require.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="base.html">                 base.js               </a>                                           <a class="source" href="compact.html">                 compact.js               </a>                                           <a class="source" href="horizontal.html">                 horizontal.js               </a>                                           <a class="source" href="vertical.html">                 vertical.js               </a>                                           <a class="source" href="canvas.html">                 canvas.js               </a>                                           <a class="source" href="drop-box.html">                 drop-box.js               </a>                                           <a class="source" href="file-manager.html">                 file-manager.js               </a>                                           <a class="source" href="palette.html">                 palette.js               </a>                                           <a class="source" href="sprite.html">                 sprite.js               </a>                                           <a class="source" href="stitches.html">                 stitches.js               </a>                                           <a class="source" href="toolbar.html">                 toolbar.js               </a>                                           <a class="source" href="require.html">                 require.js               </a>                                           <a class="source" href="stitches.html">                 stitches.js               </a>                                           <a class="source" href="text.html">                 text.js               </a>                                           <a class="source" href="array.html">                 array.js               </a>                                           <a class="source" href="stitches.html">                 stitches.js               </a>                                           <a class="source" href="templates.html">                 templates.js               </a>                                           <a class="source" href="util.html">                 util.js               </a>                                           <a class="source" href="modernizr.html">                 modernizr.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               require.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/** vim: et:ts=4:sw=4:sts=4</span>
<span class="cm"> * @license RequireJS 2.1.4 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.</span>
<span class="cm"> * Available via the MIT or new BSD license.</span>
<span class="cm"> * see: http://github.com/jrburke/requirejs for details</span>
<span class="cm"> */</span>
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Not using strict: uneven strict support in browsers, #392, and causes
problems with requirejs.exec()/transpiler plugins that may not be strict.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="cm">/*jslint regexp: true, nomen: true, sloppy: true */</span>
<span class="cm">/*global window, navigator, document, importScripts, setTimeout, opera */</span>

<span class="kd">var</span> <span class="nx">requirejs</span><span class="p">,</span> <span class="nx">require</span><span class="p">,</span> <span class="nx">define</span><span class="p">;</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">baseElement</span><span class="p">,</span> <span class="nx">dataMain</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span>
        <span class="nx">interactiveScript</span><span class="p">,</span> <span class="nx">currentlyAddingScript</span><span class="p">,</span> <span class="nx">mainScript</span><span class="p">,</span> <span class="nx">subPath</span><span class="p">,</span>
        <span class="nx">version</span> <span class="o">=</span> <span class="s1">&#39;2.1.4&#39;</span><span class="p">,</span>
        <span class="nx">commentRegExp</span> <span class="o">=</span> <span class="sr">/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg</span><span class="p">,</span>
        <span class="nx">cjsRequireRegExp</span> <span class="o">=</span> <span class="sr">/[^.]\s*require\s*\(\s*[&quot;&#39;]([^&#39;&quot;\s]+)[&quot;&#39;]\s*\)/g</span><span class="p">,</span>
        <span class="nx">jsSuffixRegExp</span> <span class="o">=</span> <span class="sr">/\.js$/</span><span class="p">,</span>
        <span class="nx">currDirRegExp</span> <span class="o">=</span> <span class="sr">/^\.\//</span><span class="p">,</span>
        <span class="nx">op</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
        <span class="nx">ostring</span> <span class="o">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">toString</span><span class="p">,</span>
        <span class="nx">hasOwn</span> <span class="o">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
        <span class="nx">ap</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
        <span class="nx">apsp</span> <span class="o">=</span> <span class="nx">ap</span><span class="p">.</span><span class="nx">splice</span><span class="p">,</span>
        <span class="nx">isBrowser</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">navigator</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">),</span>
        <span class="nx">isWebWorker</span> <span class="o">=</span> <span class="o">!</span><span class="nx">isBrowser</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">importScripts</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>PS3 indicates loaded and complete, but need to wait for complete
specifically. Sequence is 'loading', 'loaded', execution,
then 'complete'. The UA check is unfortunate, but not sure how
to feature test w/o causing perf issues.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">readyRegExp</span> <span class="o">=</span> <span class="nx">isBrowser</span> <span class="o">&amp;&amp;</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span> <span class="o">===</span> <span class="s1">&#39;PLAYSTATION 3&#39;</span> <span class="o">?</span>
                      <span class="sr">/^complete$/</span> <span class="o">:</span> <span class="sr">/^(complete|loaded)$/</span><span class="p">,</span>
        <span class="nx">defContextName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Oh the tragedy, detecting opera. See the usage of isOpera for reason.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">isOpera</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">opera</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">opera</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;[object Opera]&#39;</span><span class="p">,</span>
        <span class="nx">contexts</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">cfg</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">globalDefQueue</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">useInteractive</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ostring</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Function]&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ostring</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Helper function for iterating over an array. If the func returns</span>
<span class="cm">     * a true value, it will break out of the loop.</span>
<span class="cm">     */</span>
    <span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">ary</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ary</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">func</span><span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ary</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Helper function for iterating over an array backwards. If the func</span>
<span class="cm">     * returns a true value, it will break out of the loop.</span>
<span class="cm">     */</span>
    <span class="kd">function</span> <span class="nx">eachReverse</span><span class="p">(</span><span class="nx">ary</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ary</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">func</span><span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ary</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Cycles over properties in an object and calls a function for each</span>
<span class="cm">     * property value. If the function returns a truthy value, then the</span>
<span class="cm">     * iteration is stopped.</span>
<span class="cm">     */</span>
    <span class="kd">function</span> <span class="nx">eachProp</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prop</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">func</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Simple function to mix in properties from source into target,</span>
<span class="cm">     * but only if target does not already have a property of the same name.</span>
<span class="cm">     */</span>
    <span class="kd">function</span> <span class="nx">mixin</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">force</span><span class="p">,</span> <span class="nx">deepStringMixin</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">eachProp</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">force</span> <span class="o">||</span> <span class="o">!</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">deepStringMixin</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">target</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="p">{</span>
                            <span class="nx">target</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="p">}</span>
                        <span class="nx">mixin</span><span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">force</span><span class="p">,</span> <span class="nx">deepStringMixin</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">target</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Similar to Function.prototype.bind, but the 'this' object is specified
first, since it is easier to read/figure out what 'this' will be.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">scripts</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Allow getting a global that expressed in
dot notation, like 'a.b.c'.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">getGlobal</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">global</span><span class="p">;</span>
        <span class="nx">each</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">g</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="nx">part</span><span class="p">];</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">g</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Constructs an error with a pointer to an URL with more information.</span>
<span class="cm">     * @param {String} id the error ID that maps to an ID on a web page.</span>
<span class="cm">     * @param {String} message human readable error.</span>
<span class="cm">     * @param {Error} [err] the original error, if there is one.</span>
<span class="cm">     *</span>
<span class="cm">     * @returns {Error}</span>
<span class="cm">     */</span>
    <span class="kd">function</span> <span class="nx">makeError</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">requireModules</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span> <span class="o">+</span> <span class="s1">&#39;\nhttp://requirejs.org/docs/errors.html#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">requireType</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">=</span> <span class="nx">requireModules</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">originalError</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>If a define is already in play via another AMD loader,
do not overwrite.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">requirejs</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">requirejs</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Do not overwrite and existing requirejs instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">cfg</span> <span class="o">=</span> <span class="nx">requirejs</span><span class="p">;</span>
        <span class="nx">requirejs</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Allow for a require config object</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">require</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">require</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>assume it is a config object.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">cfg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">;</span>
        <span class="nx">require</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">newContext</span><span class="p">(</span><span class="nx">contextName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">inCheckLoaded</span><span class="p">,</span> <span class="nx">Module</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">handlers</span><span class="p">,</span>
            <span class="nx">checkLoadedTimeoutId</span><span class="p">,</span>
            <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">waitSeconds</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
                <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">&#39;./&#39;</span><span class="p">,</span>
                <span class="nx">paths</span><span class="o">:</span> <span class="p">{},</span>
                <span class="nx">pkgs</span><span class="o">:</span> <span class="p">{},</span>
                <span class="nx">shim</span><span class="o">:</span> <span class="p">{},</span>
                <span class="nx">map</span><span class="o">:</span> <span class="p">{},</span>
                <span class="nx">config</span><span class="o">:</span> <span class="p">{}</span>
            <span class="p">},</span>
            <span class="nx">registry</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">undefEvents</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">defQueue</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">defined</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">urlFetched</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">requireCounter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">unnormalizedCounter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/**</span>
<span class="cm">         * Trims the . and .. from an array of path segments.</span>
<span class="cm">         * It will keep a leading path segment if a .. will become</span>
<span class="cm">         * the first path segment, to help with module name lookups,</span>
<span class="cm">         * which act like paths, but can be remapped. But the end result,</span>
<span class="cm">         * all paths that use this function should look normalized.</span>
<span class="cm">         * NOTE: this method MODIFIES the input array.</span>
<span class="cm">         * @param {Array} ary the array of path segments.</span>
<span class="cm">         */</span>
        <span class="kd">function</span> <span class="nx">trimDots</span><span class="p">(</span><span class="nx">ary</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">part</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">part</span> <span class="o">=</span> <span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">part</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">ary</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">part</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span> <span class="o">||</span> <span class="nx">ary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>End of the line. Keep at least one non-dot
path segment at the front so it can be mapped
correctly to disk. Otherwise, there is likely
no path mapping for a path starting with '..'.
This can still fail, but catches the most reasonable
uses of ..</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">ary</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
                        <span class="nx">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/**</span>
<span class="cm">         * Given a relative module name, like ./something, normalize it to</span>
<span class="cm">         * a real name that can be mapped to a path.</span>
<span class="cm">         * @param {String} name the relative name</span>
<span class="cm">         * @param {String} baseName a real name that the name arg is relative</span>
<span class="cm">         * to.</span>
<span class="cm">         * @param {Boolean} applyMap apply the map config to the value. Should</span>
<span class="cm">         * only be done if this normalization is for a dependency ID.</span>
<span class="cm">         * @returns {String} normalized name</span>
<span class="cm">         */</span>
        <span class="kd">function</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">baseName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pkgName</span><span class="p">,</span> <span class="nx">pkgConfig</span><span class="p">,</span> <span class="nx">mapValue</span><span class="p">,</span> <span class="nx">nameParts</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">nameSegment</span><span class="p">,</span>
                <span class="nx">foundMap</span><span class="p">,</span> <span class="nx">foundI</span><span class="p">,</span> <span class="nx">foundStarMap</span><span class="p">,</span> <span class="nx">starI</span><span class="p">,</span>
                <span class="nx">baseParts</span> <span class="o">=</span> <span class="nx">baseName</span> <span class="o">&amp;&amp;</span> <span class="nx">baseName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
                <span class="nx">normalizedBaseParts</span> <span class="o">=</span> <span class="nx">baseParts</span><span class="p">,</span>
                <span class="nx">map</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
                <span class="nx">starMap</span> <span class="o">=</span> <span class="nx">map</span> <span class="o">&amp;&amp;</span> <span class="nx">map</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">];</span>

</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Adjust any relative paths.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>If have a base name, try to normalize against it,
otherwise, assume it is a top-level require that will
be relative to baseUrl in the end.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">baseName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">getOwn</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span><span class="p">,</span> <span class="nx">baseName</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If the baseName is a package name, then just treat it as one
name to concat the name with.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">normalizedBaseParts</span> <span class="o">=</span> <span class="nx">baseParts</span> <span class="o">=</span> <span class="p">[</span><span class="nx">baseName</span><span class="p">];</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Convert baseName to array, and lop off the last part,
so that . matches that 'directory' and not name of the baseName's
module. For instance, baseName of 'one/two/three', maps to
'one/two/three.js', but we want the directory, 'one/two' for
this normalization.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">normalizedBaseParts</span> <span class="o">=</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">normalizedBaseParts</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">));</span>
                    <span class="nx">trimDots</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Some use of packages may use a . path to reference the
'main' module name, so normalize for that.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">pkgConfig</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span><span class="p">,</span> <span class="p">(</span><span class="nx">pkgName</span> <span class="o">=</span> <span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">pkgConfig</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span> <span class="o">===</span> <span class="nx">pkgName</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">pkgConfig</span><span class="p">.</span><span class="nx">main</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">name</span> <span class="o">=</span> <span class="nx">pkgName</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>No baseName, so this is ID is resolved relative
to baseUrl, pull off the leading dot.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Apply map config if available.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">applyMap</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">baseParts</span> <span class="o">||</span> <span class="nx">starMap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">nameParts</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">nameSegment</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">baseParts</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Find the longest baseName segment match in the config.
So, do joins on the biggest to smallest lengths of baseParts.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">mapValue</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">));</span>

</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>baseName segment has config, find if it has one for
this name.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">mapValue</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">mapValue</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">mapValue</span><span class="p">,</span> <span class="nx">nameSegment</span><span class="p">);</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">mapValue</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Match, update name to the new value.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                                    <span class="nx">foundMap</span> <span class="o">=</span> <span class="nx">mapValue</span><span class="p">;</span>
                                    <span class="nx">foundI</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
                                    <span class="k">break</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">foundMap</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Check for a star map match, but just hold on to it,
if there is a shorter segment match later in a matching
config, then favor over this star map.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">foundStarMap</span> <span class="o">&amp;&amp;</span> <span class="nx">starMap</span> <span class="o">&amp;&amp;</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">starMap</span><span class="p">,</span> <span class="nx">nameSegment</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">foundStarMap</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">starMap</span><span class="p">,</span> <span class="nx">nameSegment</span><span class="p">);</span>
                        <span class="nx">starI</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">foundMap</span> <span class="o">&amp;&amp;</span> <span class="nx">foundStarMap</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">foundMap</span> <span class="o">=</span> <span class="nx">foundStarMap</span><span class="p">;</span>
                    <span class="nx">foundI</span> <span class="o">=</span> <span class="nx">starI</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">foundMap</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">nameParts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">foundI</span><span class="p">,</span> <span class="nx">foundMap</span><span class="p">);</span>
                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">removeScript</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">isBrowser</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">each</span><span class="p">(</span><span class="nx">scripts</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">scriptNode</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">scriptNode</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requiremodule&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">name</span> <span class="o">&amp;&amp;</span>
                            <span class="nx">scriptNode</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requirecontext&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">context</span><span class="p">.</span><span class="nx">contextName</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">scriptNode</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">scriptNode</span><span class="p">);</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">hasPathFallback</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pathConfig</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">paths</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathConfig</span> <span class="o">&amp;&amp;</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">pathConfig</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">pathConfig</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">removeScript</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Pop off the first array value, since it failed, and
retry</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">pathConfig</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">.</span><span class="nx">undef</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
                <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">([</span><span class="nx">id</span><span class="p">]);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Turns a plugin!resource to [plugin, resource]
with the plugin being undefined if the name
did not have a plugin prefix.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="kd">function</span> <span class="nx">splitPrefix</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">prefix</span><span class="p">,</span>
                <span class="nx">index</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">?</span> <span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
                <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">[</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">name</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="cm">/**</span>
<span class="cm">         * Creates a module mapping that includes plugin prefix, module</span>
<span class="cm">         * name, and path. If parentModuleMap is provided it will</span>
<span class="cm">         * also normalize the name via require.normalize()</span>
<span class="cm">         *</span>
<span class="cm">         * @param {String} name the module name</span>
<span class="cm">         * @param {String} [parentModuleMap] parent module map</span>
<span class="cm">         * for the module name, used to resolve relative names.</span>
<span class="cm">         * @param {Boolean} isNormalized: is the ID already normalized.</span>
<span class="cm">         * This is true if this call is done for a define() module ID.</span>
<span class="cm">         * @param {Boolean} applyMap: apply the map config to the ID.</span>
<span class="cm">         * Should only be true if this map is for a dependency.</span>
<span class="cm">         *</span>
<span class="cm">         * @returns {Object}</span>
<span class="cm">         */</span>
        <span class="kd">function</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentModuleMap</span><span class="p">,</span> <span class="nx">isNormalized</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">pluginModule</span><span class="p">,</span> <span class="nx">suffix</span><span class="p">,</span> <span class="nx">nameParts</span><span class="p">,</span>
                <span class="nx">prefix</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">parentName</span> <span class="o">=</span> <span class="nx">parentModuleMap</span> <span class="o">?</span> <span class="nx">parentModuleMap</span><span class="p">.</span><span class="nx">name</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">originalName</span> <span class="o">=</span> <span class="nx">name</span><span class="p">,</span>
                <span class="nx">isDefine</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">normalizedName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>If no name, then it means it is a require call, generate an
internal name.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">isDefine</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;_@r&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">requireCounter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">nameParts</span> <span class="o">=</span> <span class="nx">splitPrefix</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
            <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">);</span>
                <span class="nx">pluginModule</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">);</span>
            <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Account for relative paths if there is a base name.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">pluginModule</span> <span class="o">&amp;&amp;</span> <span class="nx">pluginModule</span><span class="p">.</span><span class="nx">normalize</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Plugin is loaded, use its normalize method.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">normalizedName</span> <span class="o">=</span> <span class="nx">pluginModule</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">);</span>
                        <span class="p">});</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">normalizedName</span> <span class="o">=</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>A regular module.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">normalizedName</span> <span class="o">=</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Normalized name may be a plugin ID due to map config
application in normalize. The map config values must
already be normalized, so do not need to redo that part.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">nameParts</span> <span class="o">=</span> <span class="nx">splitPrefix</span><span class="p">(</span><span class="nx">normalizedName</span><span class="p">);</span>
                    <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                    <span class="nx">normalizedName</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                    <span class="nx">isNormalized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                    <span class="nx">url</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nameToUrl</span><span class="p">(</span><span class="nx">normalizedName</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>If the id is a plugin id that cannot be determined if it needs
normalization, stamp it with a unique ID so two matching relative
ids that may conflict can be separate.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">suffix</span> <span class="o">=</span> <span class="nx">prefix</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">pluginModule</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isNormalized</span> <span class="o">?</span>
                     <span class="s1">&#39;_unnormalized&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">unnormalizedCounter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>
                     <span class="s1">&#39;&#39;</span><span class="p">;</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">prefix</span><span class="o">:</span> <span class="nx">prefix</span><span class="p">,</span>
                <span class="nx">name</span><span class="o">:</span> <span class="nx">normalizedName</span><span class="p">,</span>
                <span class="nx">parentMap</span><span class="o">:</span> <span class="nx">parentModuleMap</span><span class="p">,</span>
                <span class="nx">unnormalized</span><span class="o">:</span> <span class="o">!!</span><span class="nx">suffix</span><span class="p">,</span>
                <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
                <span class="nx">originalName</span><span class="o">:</span> <span class="nx">originalName</span><span class="p">,</span>
                <span class="nx">isDefine</span><span class="o">:</span> <span class="nx">isDefine</span><span class="p">,</span>
                <span class="nx">id</span><span class="o">:</span> <span class="p">(</span><span class="nx">prefix</span> <span class="o">?</span>
                        <span class="nx">prefix</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span> <span class="o">+</span> <span class="nx">normalizedName</span> <span class="o">:</span>
                        <span class="nx">normalizedName</span><span class="p">)</span> <span class="o">+</span> <span class="nx">suffix</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">getModule</span><span class="p">(</span><span class="nx">depMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">depMap</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">mod</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">on</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="o">!</span><span class="nx">mod</span> <span class="o">||</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">defineEmitComplete</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;defined&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fn</span><span class="p">(</span><span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">getModule</span><span class="p">(</span><span class="nx">depMap</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span><span class="p">,</span>
                <span class="nx">notified</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">errback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">each</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Set error on module, so it skips timeout checks.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">mod</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">notified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="nx">mod</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">});</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">notified</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">req</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/**</span>
<span class="cm">         * Internal method to transfer globalQueue items to this context&#39;s</span>
<span class="cm">         * defQueue.</span>
<span class="cm">         */</span>
        <span class="kd">function</span> <span class="nx">takeGlobalQueue</span><span class="p">()</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Push all the globalDefQueue items into the context's defQueue</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">globalDefQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Array splice in the values since the context code has a
local var ref to defQueue, so cannot just reassign the one
on context.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">apsp</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">defQueue</span><span class="p">,</span>
                           <span class="p">[</span><span class="nx">defQueue</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">globalDefQueue</span><span class="p">));</span>
                <span class="nx">globalDefQueue</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;require&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">require</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">require</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">makeRequire</span><span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;exports&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mod</span><span class="p">.</span><span class="nx">usingExports</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{});</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;module&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">module</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">module</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="nx">id</span><span class="o">:</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                        <span class="nx">uri</span><span class="o">:</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
                        <span class="nx">config</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">config</span> <span class="o">&amp;&amp;</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="o">||</span> <span class="p">{};</span>
                        <span class="p">},</span>
                        <span class="nx">exports</span><span class="o">:</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">cleanRegistry</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Clean up machinery used for waiting modules.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">delete</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">breakCycle</span><span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="nx">traced</span><span class="p">,</span> <span class="nx">processed</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mod</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">traced</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">each</span><span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">depId</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                        <span class="nx">dep</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">depId</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Only force things that have not completed
being defined, so still in the registry,
and only if it has not been matched up
in the module already.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">dep</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">depMatched</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">processed</span><span class="p">[</span><span class="nx">depId</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">getOwn</span><span class="p">(</span><span class="nx">traced</span><span class="p">,</span> <span class="nx">depId</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">mod</span><span class="p">.</span><span class="nx">defineDep</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">depId</span><span class="p">]);</span>
                            <span class="nx">mod</span><span class="p">.</span><span class="nx">check</span><span class="p">();</span> <span class="c1">//pass false?</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">breakCycle</span><span class="p">(</span><span class="nx">dep</span><span class="p">,</span> <span class="nx">traced</span><span class="p">,</span> <span class="nx">processed</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">});</span>
                <span class="nx">processed</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">checkLoaded</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">modId</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">usingPathFallback</span><span class="p">,</span>
                <span class="nx">waitInterval</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">waitSeconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>It is possible to disable the wait interval by using waitSeconds of 0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">expired</span> <span class="o">=</span> <span class="nx">waitInterval</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">+</span> <span class="nx">waitInterval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>
                <span class="nx">noLoads</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">reqCalls</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">stillLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">needCycleCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Do not bother if this call was a result of a cycle break.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">inCheckLoaded</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">inCheckLoaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Figure out the state of all the modules.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">eachProp</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">map</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
                <span class="nx">modId</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Skip things that are not enabled or in error state.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reqCalls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mod</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>If the module should be executed, and it has not
been inited and time is up, remember it.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span> <span class="o">&amp;&amp;</span> <span class="nx">expired</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasPathFallback</span><span class="p">(</span><span class="nx">modId</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">usingPathFallback</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="nx">stillLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">noLoads</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">modId</span><span class="p">);</span>
                            <span class="nx">removeScript</span><span class="p">(</span><span class="nx">modId</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span> <span class="o">&amp;&amp;</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">fetched</span> <span class="o">&amp;&amp;</span> <span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">stillLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>No reason to keep looking for unfinished
loading. If the only stillLoading is a
plugin resource though, keep going,
because it may be that a plugin resource
is waiting on a non-plugin cycle.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="k">return</span> <span class="p">(</span><span class="nx">needCycleCheck</span> <span class="o">=</span> <span class="kc">false</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">});</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">expired</span> <span class="o">&amp;&amp;</span> <span class="nx">noLoads</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>If wait time expired, throw error of unloaded modules.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">err</span> <span class="o">=</span> <span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;Load timeout for modules: &#39;</span> <span class="o">+</span> <span class="nx">noLoads</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">noLoads</span><span class="p">);</span>
                <span class="nx">err</span><span class="p">.</span><span class="nx">contextName</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">contextName</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Not expired, check for a cycle.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">needCycleCheck</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">each</span><span class="p">(</span><span class="nx">reqCalls</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">breakCycle</span><span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{});</span>
                <span class="p">});</span>
            <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>If still waiting on loads, and the waiting load is something
other than a plugin resource, or there are still outstanding
scripts, then just try back later.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">expired</span> <span class="o">||</span> <span class="nx">usingPathFallback</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">stillLoading</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Something is still waiting to load. Wait for it, but only
if a timeout is not already in effect.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">((</span><span class="nx">isBrowser</span> <span class="o">||</span> <span class="nx">isWebWorker</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">checkLoadedTimeoutId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">checkLoadedTimeoutId</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="nx">checkLoadedTimeoutId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="nx">checkLoaded</span><span class="p">();</span>
                    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nx">inCheckLoaded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">Module</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">undefEvents</span><span class="p">,</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">map</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">shim</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">shim</span><span class="p">,</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depExports</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depMatched</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">pluginMaps</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="cm">/* this.exports this.factory</span>
<span class="cm">               this.depMaps = [],</span>
<span class="cm">               this.enabled, this.fetched</span>
<span class="cm">            */</span>
        <span class="p">};</span>

        <span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depMaps</span><span class="p">,</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Do not do more inits if already done. Can happen if there
are multiple define calls for the same module. That is not
a normal, common case, but it is also not unexpected.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inited</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">factory</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Register for errors on this module.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">errback</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>If no errback already, but there are error listeners
on this module, set up an errback to pass to the deps.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">errback</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Do a copy of the dependency array, so that
source inputs are not modified. For example
"shim" deps are passed in here directly, and
doing a direct modification of the depMaps array
would affect that config.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span> <span class="o">=</span> <span class="nx">depMaps</span> <span class="o">&amp;&amp;</span> <span class="nx">depMaps</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">errback</span> <span class="o">=</span> <span class="nx">errback</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Indicate this module has be initialized</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">inited</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">ignore</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ignore</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Could have option to init this module in enabled mode,
or could have been previously marked as enabled. However,
the dependencies are not known until init is called. So
if enabled previously, now trigger dependencies as enabled.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Enable this module and dependencies.
Will call this.check()</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">this</span><span class="p">.</span><span class="nx">enable</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">defineDep</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Because of cycles, defined callback for a given
export can be called more than once.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">depMatched</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">depMatched</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">depCount</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">depExports</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">depExports</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fetched</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">fetched</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="nx">context</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>

                <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>If the manager is for a plugin managed resource,
ask the plugin to load it now.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shim</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">makeRequire</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">enableBuildCallback</span><span class="o">:</span> <span class="kc">true</span>
                    <span class="p">})(</span><span class="k">this</span><span class="p">.</span><span class="nx">shim</span><span class="p">.</span><span class="nx">deps</span> <span class="o">||</span> <span class="p">[],</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">callPlugin</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">();</span>
                    <span class="p">}));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Regular dependency.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">return</span> <span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">callPlugin</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Regular dependency.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">urlFetched</span><span class="p">[</span><span class="nx">url</span><span class="p">])</span> <span class="p">{</span>
                    <span class="nx">urlFetched</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="cm">/**</span>
<span class="cm">             * Checks is the module is ready to define itself, and if so,</span>
<span class="cm">             * define it.</span>
<span class="cm">             */</span>
            <span class="nx">check</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">enabling</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="kd">var</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">cjsModule</span><span class="p">,</span>
                    <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                    <span class="nx">depExports</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">depExports</span><span class="p">,</span>
                    <span class="nx">exports</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
                    <span class="nx">factory</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">factory</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">inited</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">defining</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>The factory could trigger another require call
that would result in checking this module to
define itself again. If already in the process
of doing that, skip this work.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">this</span><span class="p">.</span><span class="nx">defining</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">depCount</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">defined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">factory</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>If there is an error listener, favor passing
to that instead of throwing an error.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">try</span> <span class="p">{</span>
                                    <span class="nx">exports</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">execCb</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">,</span> <span class="nx">exports</span><span class="p">);</span>
                                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nx">err</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">exports</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">execCb</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">,</span> <span class="nx">exports</span><span class="p">);</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>If setting exports via 'module' is in play,
favor that over return value and exports. After that,
favor a non-undefined return value over exports use.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                                <span class="nx">cjsModule</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">module</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">cjsModule</span> <span class="o">&amp;&amp;</span>
                                        <span class="nx">cjsModule</span><span class="p">.</span><span class="nx">exports</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span>
</pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Make sure it is not already the exports value</p>             </td>             <td class="code">               <div class="highlight"><pre>
                                        <span class="nx">cjsModule</span><span class="p">.</span><span class="nx">exports</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nx">exports</span> <span class="o">=</span> <span class="nx">cjsModule</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">usingExports</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>exports already set the defined value.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                                    <span class="nx">exports</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">err</span><span class="p">.</span><span class="nx">requireMap</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
                                <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
                                <span class="nx">err</span><span class="p">.</span><span class="nx">requireType</span> <span class="o">=</span> <span class="s1">&#39;define&#39;</span><span class="p">;</span>
                                <span class="k">return</span> <span class="nx">onError</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">));</span>
                            <span class="p">}</span>

                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Just a literal value</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="k">this</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ignore</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>

                            <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">onResourceLoad</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">req</span><span class="p">.</span><span class="nx">onResourceLoad</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Clean up</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">delete</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

                        <span class="k">this</span><span class="p">.</span><span class="nx">defined</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Finished the define stage. Allow calling check again
to allow define notifications below in the case of a
cycle.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">this</span><span class="p">.</span><span class="nx">defining</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defined</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">defineEmitted</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">defineEmitted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">);</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">defineEmitComplete</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>

                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">callPlugin</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
                    <span class="nx">id</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Map already normalized the prefix.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">pluginMap</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Mark this as a dependency for this plugin, so it
can be traced for cycles.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pluginMap</span><span class="p">);</span>

                <span class="nx">on</span><span class="p">(</span><span class="nx">pluginMap</span><span class="p">,</span> <span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">plugin</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">normalizedMap</span><span class="p">,</span> <span class="nx">normalizedMod</span><span class="p">,</span>
                        <span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                        <span class="nx">parentName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span><span class="p">.</span><span class="nx">name</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                        <span class="nx">localRequire</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">makeRequire</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span><span class="p">,</span> <span class="p">{</span>
                            <span class="nx">enableBuildCallback</span><span class="o">:</span> <span class="kc">true</span>
                        <span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>If current map is not normalized, wait for that
normalized name to load instead of continuing.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">unnormalized</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Normalize the ID if the plugin allows it.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">normalize</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">name</span> <span class="o">=</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                            <span class="p">})</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>prefix and name should already be normalized, no need
for applying map config again either.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">normalizedMap</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">,</span>
                                                      <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span><span class="p">);</span>
                        <span class="nx">on</span><span class="p">(</span><span class="nx">normalizedMap</span><span class="p">,</span>
                            <span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">([],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">value</span><span class="p">;</span> <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                                    <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                                    <span class="nx">ignore</span><span class="o">:</span> <span class="kc">true</span>
                                <span class="p">});</span>
                            <span class="p">}));</span>

                        <span class="nx">normalizedMod</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">normalizedMap</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">normalizedMod</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Mark this as a dependency for this plugin, so it
can be traced for cycles.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">normalizedMap</span><span class="p">);</span>

                            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">normalizedMod</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                                <span class="p">}));</span>
                            <span class="p">}</span>
                            <span class="nx">normalizedMod</span><span class="p">.</span><span class="nx">enable</span><span class="p">();</span>
                        <span class="p">}</span>

                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">load</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">([],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">value</span><span class="p">;</span> <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                            <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span>
                        <span class="p">});</span>
                    <span class="p">});</span>

                    <span class="nx">load</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">inited</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
                        <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">=</span> <span class="p">[</span><span class="nx">id</span><span class="p">];</span>

</pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Remove temp unnormalized modules for this module,
since they will never be resolved otherwise now.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">eachProp</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;_unnormalized&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">cleanRegistry</span><span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">});</span>

                        <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                    <span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Allow plugins to load other code without having to know the
context or how to 'complete' the load.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">load</span><span class="p">.</span><span class="nx">fromText</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">textAlt</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/*jslint evil: true */</span>
                        <span class="kd">var</span> <span class="nx">moduleName</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                            <span class="nx">moduleMap</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">),</span>
                            <span class="nx">hasInteractive</span> <span class="o">=</span> <span class="nx">useInteractive</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>As of 2.1.0, support just passing the text, to reinforce
fromText only being called once per resource. Still
support old style of passing moduleName but discard
that moduleName in favor of the internal ref.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">textAlt</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">text</span> <span class="o">=</span> <span class="nx">textAlt</span><span class="p">;</span>
                        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Turn off interactive script matching for IE for any define
calls in the text, then turn it back on at the end.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasInteractive</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">useInteractive</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Prime the system by creating a module instance for
it.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">getModule</span><span class="p">(</span><span class="nx">moduleMap</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Transfer any config to this other module.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">config</span><span class="p">.</span><span class="nx">config</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">config</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
                        <span class="p">}</span>

                        <span class="k">try</span> <span class="p">{</span>
                            <span class="nx">req</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;fromtexteval&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;fromText eval for &#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span>
                                            <span class="s1">&#39; failed: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">,</span>
                                             <span class="nx">e</span><span class="p">,</span>
                                             <span class="p">[</span><span class="nx">id</span><span class="p">]));</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasInteractive</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">useInteractive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Mark this as a dependency for the plugin
resource</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">moduleMap</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Support anonymous modules.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">context</span><span class="p">.</span><span class="nx">completeLoad</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Bind the value of that module to the value for this
resource ID.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">localRequire</span><span class="p">([</span><span class="nx">moduleName</span><span class="p">],</span> <span class="nx">load</span><span class="p">);</span>
                    <span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Use parentName here since the plugin's name is not reliable,
could be some weird string with no path that actually wants to
reference the parentName's path.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">plugin</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">localRequire</span><span class="p">,</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
                <span class="p">}));</span>

                <span class="nx">context</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">pluginMap</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">pluginMaps</span><span class="p">[</span><span class="nx">pluginMap</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pluginMap</span><span class="p">;</span>
            <span class="p">},</span>

            <span class="nx">enable</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Set flag mentioning that the module is enabling,
so that immediate calls to the defined callbacks
for dependencies do not trigger inadvertent load
with the depCount still being zero.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">enabling</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Enable each dependency</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">mod</span><span class="p">,</span> <span class="nx">handler</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">depMap</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Dependency needs to be converted to a depMap
and wired up to this module.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">depMap</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span>
                                               <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span><span class="p">),</span>
                                               <span class="kc">false</span><span class="p">,</span>
                                               <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">skipMap</span><span class="p">);</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">;</span>

                        <span class="nx">handler</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">handlers</span><span class="p">,</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">depExports</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="k">this</span><span class="p">.</span><span class="nx">depCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

                        <span class="nx">on</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depExports</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">defineDep</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">);</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">();</span>
                        <span class="p">}));</span>

                        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">on</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">errback</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="nx">id</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                    <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

</pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Skip special modules like 'require', 'exports', 'module'
Also, don't call enable if it is already enabled,
important in circular dependency cases.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">handlers</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">context</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}));</span>

</pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Enable each plugin that is used in
a dependency</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">eachProp</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pluginMaps</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pluginMap</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">pluginMap</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">context</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">pluginMap</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}));</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">enabling</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">on</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">cbs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cbs</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cbs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="p">}</span>
                <span class="nx">cbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">emit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Now that the error handler was triggered, remove
the listeners, since this broken Module instance
can stay around for a while in the registry.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">callGetModule</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Skip modules already defined.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nx">getModule</span><span class="p">(</span><span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)).</span><span class="nx">init</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">removeListener</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ieName</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Favor detachEvent because of IE9
issue, see attachEvent/addEventListener comment elsewhere
in this file.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">detachEvent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isOpera</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Probably IE. If not it will throw an error, which will be
useful to know.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ieName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">node</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="nx">ieName</span><span class="p">,</span> <span class="nx">func</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/**</span>
<span class="cm">         * Given an event from a script node, get the requirejs info from it,</span>
<span class="cm">         * and then removes the event listeners on the node.</span>
<span class="cm">         * @param {Event} evt</span>
<span class="cm">         * @returns {Object}</span>
<span class="cm">         */</span>
        <span class="kd">function</span> <span class="nx">getScriptData</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Using currentTarget instead of target for Firefox 2.0's sake. Not
all old browsers will be supported, but this one was easy enough
to support and still makes sense.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">currentTarget</span> <span class="o">||</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Remove the listeners once here.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">removeListener</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptLoad</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="s1">&#39;onreadystatechange&#39;</span><span class="p">);</span>
            <span class="nx">removeListener</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptError</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">node</span><span class="o">:</span> <span class="nx">node</span><span class="p">,</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">node</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requiremodule&#39;</span><span class="p">)</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">intakeDefines</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">args</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Any defined modules in the global queue, intake them now.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">takeGlobalQueue</span><span class="p">();</span>

</pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Make sure any remaining defQueue items get properly processed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">while</span> <span class="p">(</span><span class="nx">defQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">args</span> <span class="o">=</span> <span class="nx">defQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;mismatch&#39;</span><span class="p">,</span> <span class="s1">&#39;Mismatched anonymous define() module: &#39;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>args are id, deps, factory. Should be normalized by the
define() function.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">callGetModule</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">config</span><span class="o">:</span> <span class="nx">config</span><span class="p">,</span>
            <span class="nx">contextName</span><span class="o">:</span> <span class="nx">contextName</span><span class="p">,</span>
            <span class="nx">registry</span><span class="o">:</span> <span class="nx">registry</span><span class="p">,</span>
            <span class="nx">defined</span><span class="o">:</span> <span class="nx">defined</span><span class="p">,</span>
            <span class="nx">urlFetched</span><span class="o">:</span> <span class="nx">urlFetched</span><span class="p">,</span>
            <span class="nx">defQueue</span><span class="o">:</span> <span class="nx">defQueue</span><span class="p">,</span>
            <span class="nx">Module</span><span class="o">:</span> <span class="nx">Module</span><span class="p">,</span>
            <span class="nx">makeModuleMap</span><span class="o">:</span> <span class="nx">makeModuleMap</span><span class="p">,</span>
            <span class="nx">nextTick</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">,</span>

            <span class="cm">/**</span>
<span class="cm">             * Set a configuration for the context.</span>
<span class="cm">             * @param {Object} cfg config object to integrate.</span>
<span class="cm">             */</span>
            <span class="nx">configure</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Make sure the baseUrl ends in a slash.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Save off the paths and packages since they require special processing,
they are additive.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="kd">var</span> <span class="nx">pkgs</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span><span class="p">,</span>
                    <span class="nx">shim</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">shim</span><span class="p">,</span>
                    <span class="nx">objs</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="nx">paths</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                        <span class="nx">config</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                        <span class="nx">map</span><span class="o">:</span> <span class="kc">true</span>
                    <span class="p">};</span>

                <span class="nx">eachProp</span><span class="p">(</span><span class="nx">cfg</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">objs</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">prop</span> <span class="o">===</span> <span class="s1">&#39;map&#39;</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">mixin</span><span class="p">(</span><span class="nx">config</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">mixin</span><span class="p">(</span><span class="nx">config</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">config</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Merge shim</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">shim</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">eachProp</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">shim</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Normalize the structure</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="nx">deps</span><span class="o">:</span> <span class="nx">value</span>
                            <span class="p">};</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">((</span><span class="nx">value</span><span class="p">.</span><span class="nx">exports</span> <span class="o">||</span> <span class="nx">value</span><span class="p">.</span><span class="nx">init</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">value</span><span class="p">.</span><span class="nx">exportsFn</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">value</span><span class="p">.</span><span class="nx">exportsFn</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">makeShimExports</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">shim</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="p">});</span>
                    <span class="nx">config</span><span class="p">.</span><span class="nx">shim</span> <span class="o">=</span> <span class="nx">shim</span><span class="p">;</span>
                <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Adjust packages if necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">packages</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">each</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">packages</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pkgObj</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">location</span><span class="p">;</span>

                        <span class="nx">pkgObj</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">pkgObj</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">pkgObj</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">pkgObj</span><span class="p">;</span>
                        <span class="nx">location</span> <span class="o">=</span> <span class="nx">pkgObj</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Create a brand new object on pkgs, since currentPackages can
be passed in again, and config.pkgs is the internal transformed
state for all package configs.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">pkgs</span><span class="p">[</span><span class="nx">pkgObj</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="nx">pkgObj</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                            <span class="nx">location</span><span class="o">:</span> <span class="nx">location</span> <span class="o">||</span> <span class="nx">pkgObj</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Remove leading dot in main, so main paths are normalized,
and remove any trailing .js, since different package
envs have different conventions: some use a module name,
some use a file name.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="nx">main</span><span class="o">:</span> <span class="p">(</span><span class="nx">pkgObj</span><span class="p">.</span><span class="nx">main</span> <span class="o">||</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">currDirRegExp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">jsSuffixRegExp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="p">};</span>
                    <span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Done with modifications, assing packages back to context config</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span> <span class="o">=</span> <span class="nx">pkgs</span><span class="p">;</span>
                <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>If there are any "waiting to execute" modules in the registry,
update the maps for them, since their info, like URLs to load,
may have changed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">eachProp</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>If module already has init called, since it is too
late to modify them, and ignore unnormalized ones
since they are transient.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">unnormalized</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>If a deps array or a config callback is specified, then call
require with those args. This is useful when require is defined as a
config object before require.js is loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span> <span class="o">||</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span> <span class="o">||</span> <span class="p">[],</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">makeShimExports</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">function</span> <span class="nx">fn</span><span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">ret</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">init</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">ret</span> <span class="o">||</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">exports</span> <span class="o">&amp;&amp;</span> <span class="nx">getGlobal</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">exports</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="p">},</span>

            <span class="nx">makeRequire</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">relMap</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

                <span class="kd">function</span> <span class="nx">localRequire</span><span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">requireMod</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">enableBuildCallback</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">callback</span><span class="p">.</span><span class="nx">__requireJsBuild</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">deps</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Invalid call</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;requireargs&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid require call&#39;</span><span class="p">),</span> <span class="nx">errback</span><span class="p">);</span>
                        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>If require|exports|module are requested, get the
value for them from the special handlers. Caveat:
this only works while module is being defined.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">relMap</span> <span class="o">&amp;&amp;</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">handlers</span><span class="p">,</span> <span class="nx">deps</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">deps</span><span class="p">](</span><span class="nx">registry</span><span class="p">[</span><span class="nx">relMap</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
                        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Synchronous access to one module. If require.get is
available (as in the Node adapter), prefer that.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">);</span>
                        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Normalize module name, if it contains . or ..</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">map</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                        <span class="nx">id</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;notloaded&#39;</span><span class="p">,</span> <span class="s1">&#39;Module name &quot;&#39;</span> <span class="o">+</span>
                                        <span class="nx">id</span> <span class="o">+</span>
                                        <span class="s1">&#39;&quot; has not been loaded yet for context: &#39;</span> <span class="o">+</span>
                                        <span class="nx">contextName</span> <span class="o">+</span>
                                        <span class="p">(</span><span class="nx">relMap</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="s1">&#39;. Use require([])&#39;</span><span class="p">)));</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
                    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Grab defines waiting in the global queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">intakeDefines</span><span class="p">();</span>

</pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Mark all the dependencies as needing to be loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Some defines could have been added since the
require call, collect them.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">intakeDefines</span><span class="p">();</span>

                        <span class="nx">requireMod</span> <span class="o">=</span> <span class="nx">getModule</span><span class="p">(</span><span class="nx">makeModuleMap</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">));</span>

</pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Store if map config should be applied to this require
call for dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">requireMod</span><span class="p">.</span><span class="nx">skipMap</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">skipMap</span><span class="p">;</span>

                        <span class="nx">requireMod</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="p">{</span>
                            <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span>
                        <span class="p">});</span>

                        <span class="nx">checkLoaded</span><span class="p">();</span>
                    <span class="p">});</span>

                    <span class="k">return</span> <span class="nx">localRequire</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="nx">mixin</span><span class="p">(</span><span class="nx">localRequire</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">isBrowser</span><span class="o">:</span> <span class="nx">isBrowser</span><span class="p">,</span>

                    <span class="cm">/**</span>
<span class="cm">                     * Converts a module name + .extension into an URL path.</span>
<span class="cm">                     * *Requires* the use of a module name. It does not support using</span>
<span class="cm">                     * plain URLs like nameToUrl.</span>
<span class="cm">                     */</span>
                    <span class="nx">toUrl</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">moduleNamePlusExt</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span>
                            <span class="nx">index</span> <span class="o">=</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span>
                            <span class="nx">segment</span> <span class="o">=</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="nx">isRelative</span> <span class="o">=</span> <span class="nx">segment</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="nx">segment</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Have a file extension alias, and it is not the
dots from a relative path.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">isRelative</span> <span class="o">||</span> <span class="nx">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">ext</span> <span class="o">=</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                            <span class="nx">moduleNamePlusExt</span> <span class="o">=</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="nx">url</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nameToUrl</span><span class="p">(</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">moduleNamePlusExt</span><span class="p">,</span>
                                                <span class="nx">relMap</span> <span class="o">&amp;&amp;</span> <span class="nx">relMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="nx">ext</span> <span class="o">||</span> <span class="s1">&#39;.fake&#39;</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nx">ext</span> <span class="o">?</span> <span class="nx">url</span> <span class="o">:</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">url</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
                    <span class="p">},</span>

                    <span class="nx">defined</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">id</span><span class="p">);</span>
                    <span class="p">},</span>

                    <span class="nx">specified</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">id</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">id</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="o">||</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Only allow undef on top level require calls</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">relMap</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">localRequire</span><span class="p">.</span><span class="nx">undef</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Bind any waiting define() calls to this context,
fix for #408</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">takeGlobalQueue</span><span class="p">();</span>

                        <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
                            <span class="nx">mod</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

                        <span class="k">delete</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
                        <span class="k">delete</span> <span class="nx">urlFetched</span><span class="p">[</span><span class="nx">map</span><span class="p">.</span><span class="nx">url</span><span class="p">];</span>
                        <span class="k">delete</span> <span class="nx">undefEvents</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Hold on to listeners in case the
module will be attempted to be reloaded
using a different config.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">defined</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">undefEvents</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">events</span><span class="p">;</span>
                            <span class="p">}</span>

                            <span class="nx">cleanRegistry</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">};</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">localRequire</span><span class="p">;</span>
            <span class="p">},</span>

            <span class="cm">/**</span>
<span class="cm">             * Called to enable a module if it is still in the registry</span>
<span class="cm">             * awaiting enablement. A second arg, parent, the parent module,</span>
<span class="cm">             * is passed in for context, when this method is overriden by</span>
<span class="cm">             * the optimizer. Not shown here to keep code compact.</span>
<span class="cm">             */</span>
            <span class="nx">enable</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depMap</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">getModule</span><span class="p">(</span><span class="nx">depMap</span><span class="p">).</span><span class="nx">enable</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="cm">/**</span>
<span class="cm">             * Internal method used by environment adapters to complete a load event.</span>
<span class="cm">             * A load event could be a script load or just a load pass from a synchronous</span>
<span class="cm">             * load call.</span>
<span class="cm">             * @param {String} moduleName the name of the module to potentially complete.</span>
<span class="cm">             */</span>
            <span class="nx">completeLoad</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">moduleName</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">mod</span><span class="p">,</span>
                    <span class="nx">shim</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">shim</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">)</span> <span class="o">||</span> <span class="p">{},</span>
                    <span class="nx">shExports</span> <span class="o">=</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>

                <span class="nx">takeGlobalQueue</span><span class="p">();</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">defQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">args</span> <span class="o">=</span> <span class="nx">defQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">moduleName</span><span class="p">;</span>
</pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>If already found an anonymous module and bound it
to this name, then this is some other anon module
waiting for its completeLoad to fire.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">moduleName</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Found matching define call for this script!</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">callGetModule</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
                <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Do this after the cycle of callGetModule in case the result
of those calls/init calls changes the registry.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">enforceDefine</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">shExports</span> <span class="o">||</span> <span class="o">!</span><span class="nx">getGlobal</span><span class="p">(</span><span class="nx">shExports</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasPathFallback</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;nodefine&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;No define call for &#39;</span> <span class="o">+</span> <span class="nx">moduleName</span><span class="p">,</span>
                                             <span class="kc">null</span><span class="p">,</span>
                                             <span class="p">[</span><span class="nx">moduleName</span><span class="p">]));</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>A script that does not call define(), so just simulate
the call for it.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                        <span class="nx">callGetModule</span><span class="p">([</span><span class="nx">moduleName</span><span class="p">,</span> <span class="p">(</span><span class="nx">shim</span><span class="p">.</span><span class="nx">deps</span> <span class="o">||</span> <span class="p">[]),</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">exportsFn</span><span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="nx">checkLoaded</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="cm">/**</span>
<span class="cm">             * Converts a module name to a file path. Supports cases where</span>
<span class="cm">             * moduleName may actually be just an URL.</span>
<span class="cm">             * Note that it **does not** call normalize on the moduleName,</span>
<span class="cm">             * it is assumed to have already been normalized. This is an</span>
<span class="cm">             * internal API, not a public one. Use toUrl for the public API.</span>
<span class="cm">             */</span>
            <span class="nx">nameToUrl</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">ext</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">paths</span><span class="p">,</span> <span class="nx">pkgs</span><span class="p">,</span> <span class="nx">pkg</span><span class="p">,</span> <span class="nx">pkgPath</span><span class="p">,</span> <span class="nx">syms</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">parentModule</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span>
                    <span class="nx">parentPath</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>If a colon is in the URL, it indicates a protocol is used and it is just
an URL to a file, or if it starts with a slash, contains a query arg (i.e. ?)
or ends with .js, then assume the user meant to use an url and not a module id.
The slash is important for protocol-less URLs as well as full paths.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">jsExtRegExp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Just a plain path, not module name lookup, so just return it.
Add extension if it is included. This is a bit wonky, only non-.js things pass
an extension, this method probably needs to be reworked.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">url</span> <span class="o">=</span> <span class="nx">moduleName</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>A module that needs to be converted to a path.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">paths</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">paths</span><span class="p">;</span>
                    <span class="nx">pkgs</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span><span class="p">;</span>

                    <span class="nx">syms</span> <span class="o">=</span> <span class="nx">moduleName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>For each module name segment, see if there is a path
registered for it. Start with most specific name
and work up from it.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">syms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">parentModule</span> <span class="o">=</span> <span class="nx">syms</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                        <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">pkgs</span><span class="p">,</span> <span class="nx">parentModule</span><span class="p">);</span>
                        <span class="nx">parentPath</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">paths</span><span class="p">,</span> <span class="nx">parentModule</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">parentPath</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>If an array, it means there are a few choices,
Choose the one that is desired</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">parentPath</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nx">parentPath</span> <span class="o">=</span> <span class="nx">parentPath</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                            <span class="p">}</span>
                            <span class="nx">syms</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">parentPath</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pkg</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>If module name is just the package name, then looking
for the main module.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">moduleName</span> <span class="o">===</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">pkgPath</span> <span class="o">=</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">pkgPath</span> <span class="o">=</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="nx">syms</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">pkgPath</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Join the path parts together, then figure out if baseUrl is needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">url</span> <span class="o">=</span> <span class="nx">syms</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                    <span class="nx">url</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">||</span> <span class="p">(</span><span class="sr">/\?/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="s1">&#39;.js&#39;</span><span class="p">));</span>
                    <span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span> <span class="o">||</span> <span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[\w\+\.\-]+:/</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">)</span> <span class="o">+</span> <span class="nx">url</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">config</span><span class="p">.</span><span class="nx">urlArgs</span> <span class="o">?</span> <span class="nx">url</span> <span class="o">+</span>
                                        <span class="p">((</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s1">&#39;?&#39;</span> <span class="o">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">)</span> <span class="o">+</span>
                                         <span class="nx">config</span><span class="p">.</span><span class="nx">urlArgs</span><span class="p">)</span> <span class="o">:</span> <span class="nx">url</span><span class="p">;</span>
            <span class="p">},</span>

</pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Delegates to req.load. Broken out as a separate function to
allow overriding in the optimizer.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="cm">/**</span>
<span class="cm">             * Executes a module callack function. Broken out as a separate function</span>
<span class="cm">             * solely to allow the build system to sequence the files in the built</span>
<span class="cm">             * layer in the right sequence.</span>
<span class="cm">             *</span>
<span class="cm">             * @private</span>
<span class="cm">             */</span>
            <span class="nx">execCb</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="cm">/**</span>
<span class="cm">             * callback for script loads, used to check status of loading.</span>
<span class="cm">             *</span>
<span class="cm">             * @param {Event} evt the event from the browser for the script</span>
<span class="cm">             * that was loaded.</span>
<span class="cm">             */</span>
            <span class="nx">onScriptLoad</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Using currentTarget instead of target for Firefox 2.0's sake. Not
all old browsers will be supported, but this one was easy enough
to support and still makes sense.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;load&#39;</span> <span class="o">||</span>
                        <span class="p">(</span><span class="nx">readyRegExp</span><span class="p">.</span><span class="nx">test</span><span class="p">((</span><span class="nx">evt</span><span class="p">.</span><span class="nx">currentTarget</span> <span class="o">||</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">).</span><span class="nx">readyState</span><span class="p">)))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Reset interactive script so a script node is not held onto for
to long.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">interactiveScript</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Pull out the name of the module and the context.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">getScriptData</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">completeLoad</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="cm">/**</span>
<span class="cm">             * Callback for script errors.</span>
<span class="cm">             */</span>
            <span class="nx">onScriptError</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">getScriptData</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasPathFallback</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;scripterror&#39;</span><span class="p">,</span> <span class="s1">&#39;Script error&#39;</span><span class="p">,</span> <span class="nx">evt</span><span class="p">,</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">]));</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="nx">context</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">makeRequire</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Main entry point.</span>
<span class="cm">     *</span>
<span class="cm">     * If the only argument to require is a string, then the module that</span>
<span class="cm">     * is represented by that string is fetched for the appropriate context.</span>
<span class="cm">     *</span>
<span class="cm">     * If the first argument is an array, then it will be treated as an array</span>
<span class="cm">     * of dependency string names to fetch. An optional function callback can</span>
<span class="cm">     * be specified to execute when all of those dependencies are available.</span>
<span class="cm">     *</span>
<span class="cm">     * Make a local req variable to help Caja compliance (it assumes things</span>
<span class="cm">     * on a require that are not standardized), and to give a short</span>
<span class="cm">     * name for minification/local scope use.</span>
<span class="cm">     */</span>
    <span class="nx">req</span> <span class="o">=</span> <span class="nx">requirejs</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="nx">optional</span><span class="p">)</span> <span class="p">{</span>

</pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Find the right context, use default</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span>
            <span class="nx">contextName</span> <span class="o">=</span> <span class="nx">defContextName</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>Determine if have config object in the call.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">deps</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">deps</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>deps is a config object</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">config</span> <span class="o">=</span> <span class="nx">deps</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Adjust args if there are dependencies</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">deps</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
                <span class="nx">callback</span> <span class="o">=</span> <span class="nx">errback</span><span class="p">;</span>
                <span class="nx">errback</span> <span class="o">=</span> <span class="nx">optional</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">deps</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span> <span class="o">&amp;&amp;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">contextName</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">context</span> <span class="o">=</span> <span class="nx">getOwn</span><span class="p">(</span><span class="nx">contexts</span><span class="p">,</span> <span class="nx">contextName</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">context</span> <span class="o">=</span> <span class="nx">contexts</span><span class="p">[</span><span class="nx">contextName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">newContext</span><span class="p">(</span><span class="nx">contextName</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Support require.config() to make it easier to cooperate with other</span>
<span class="cm">     * AMD loaders on globally agreed names.</span>
<span class="cm">     */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">req</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Execute something after the current tick</span>
<span class="cm">     * of the event loop. Override for other envs</span>
<span class="cm">     * that have a better solution than setTimeout.</span>
<span class="cm">     * @param  {Function} fn function to execute later.</span>
<span class="cm">     */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">setTimeout</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span> <span class="nx">fn</span><span class="p">();</span> <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Export require as a global, but only if it does not already exist.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">require</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">require</span> <span class="o">=</span> <span class="nx">req</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">version</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Used to filter out dependencies that are already paths.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">req</span><span class="p">.</span><span class="nx">jsExtRegExp</span> <span class="o">=</span> <span class="sr">/^\/|:|\?|\.js$/</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">isBrowser</span> <span class="o">=</span> <span class="nx">isBrowser</span><span class="p">;</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">contexts</span><span class="o">:</span> <span class="nx">contexts</span><span class="p">,</span>
        <span class="nx">newContext</span><span class="o">:</span> <span class="nx">newContext</span>
    <span class="p">};</span>

</pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Create default context.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">req</span><span class="p">({});</span>

</pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Exports some context-sensitive methods on global require.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">each</span><span class="p">([</span>
        <span class="s1">&#39;toUrl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;undef&#39;</span><span class="p">,</span>
        <span class="s1">&#39;defined&#39;</span><span class="p">,</span>
        <span class="s1">&#39;specified&#39;</span>
    <span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>Reference from contexts instead of early binding to default context,
so that during builds, the latest instance of the default context
with its config gets used.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">req</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">contexts</span><span class="p">[</span><span class="nx">defContextName</span><span class="p">];</span>
            <span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">require</span><span class="p">[</span><span class="nx">prop</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isBrowser</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">head</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>If BASE tag is in play, using appendChild is a problem for IE6.
When that browser dies, this can be removed. Details in this jQuery bug:
http://dev.jquery.com/ticket/2709</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">baseElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">baseElement</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">head</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="nx">baseElement</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Any errors that require explicitly generates will be passed to this</span>
<span class="cm">     * function. Intercept/override it if you want custom error handling.</span>
<span class="cm">     * @param {Error} err the error object.</span>
<span class="cm">     */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">onError</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Does the request to load a module for the browser case.</span>
<span class="cm">     * Make this a separate function to allow other environments</span>
<span class="cm">     * to override it.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} context the require context to find state.</span>
<span class="cm">     * @param {String} moduleName the name of the module.</span>
<span class="cm">     * @param {Object} url the URL to the module.</span>
<span class="cm">     */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span> <span class="o">||</span> <span class="p">{},</span>
            <span class="nx">node</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isBrowser</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>In the browser so use a script tag</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">node</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">xhtml</span> <span class="o">?</span>
                    <span class="nb">document</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="s1">&#39;http://www.w3.org/1999/xhtml&#39;</span><span class="p">,</span> <span class="s1">&#39;html:script&#39;</span><span class="p">)</span> <span class="o">:</span>
                    <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">scriptType</span> <span class="o">||</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">;</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">charset</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">;</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;data-requirecontext&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">contextName</span><span class="p">);</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;data-requiremodule&#39;</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>Set up load listener. Test attachEvent first because IE9 has
a subtle issue in its addEventListener and script onload firings
that do not match the behavior of all other browsers with
addEventListener support, which fire the onload event for a
script right after the script execution. See:
https://connect.microsoft.com/IE/feedback/details/648057/script-onload-event-is-not-fired-immediately-after-script-execution
UNFORTUNATELY Opera implements attachEvent but does not follow the script
script execution mode.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="o">&amp;&amp;</span>
</pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>Check if node.attachEvent is artificially added by custom script or
natively supported by browser
read https://github.com/jrburke/requirejs/issues/187
if we can NOT find [native code] then it must NOT natively supported.
in IE8, node.attachEvent does not have toString()
Note the test for "[native code" with no closing brace, see:
https://github.com/jrburke/requirejs/issues/273</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="o">!</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">.</span><span class="nx">toString</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;[native code&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="nx">isOpera</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>Probably IE. IE (at least 6-8) do not fire
script onload right after executing the script, so
we cannot tie the anonymous define call to a name.
However, IE reports the script as being in 'interactive'
readyState at the time of the define call.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">useInteractive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">&#39;onreadystatechange&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptLoad</span><span class="p">);</span>
</pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>It would be great to add an error handler here to catch
404s in IE9+. However, onreadystatechange will fire before
the error handler, so that does not help. If addEvenListener
is used, then IE will fire error before load, but we cannot
use that pathway given the connect.microsoft.com issue
mentioned above about not doing the 'script execute,
then fire the script load event listener before execute
next script' that other browsers do.
Best hope: IE10 fixes the issues,
and then destroys all installs of IE 6-9.
node.attachEvent('onerror', context.onScriptError);</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptLoad</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptError</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p>For some cache cases in IE 6-8, the script executes before the end
of the appendChild execution, so to tie an anonymous define
call to the module name (which is stored on the node), hold on
to a reference to this node, but clear after the DOM insertion.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">currentlyAddingScript</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">baseElement</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">head</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">baseElement</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">currentlyAddingScript</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

            <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isWebWorker</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>In a web worker, use importScripts. This is not a very
efficient use of importScripts, importScripts will block until
its script is downloaded and evaluated. However, if web workers
are in play, the expectation that a build has been done so that
only one script needs to be loaded anyway. This may need to be
reevaluated if other use cases become common.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">importScripts</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>Account for anonymous modules</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">context</span><span class="p">.</span><span class="nx">completeLoad</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">getInteractiveScript</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">interactiveScript</span> <span class="o">&amp;&amp;</span> <span class="nx">interactiveScript</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;interactive&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">interactiveScript</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">eachReverse</span><span class="p">(</span><span class="nx">scripts</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;interactive&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">interactiveScript</span> <span class="o">=</span> <span class="nx">script</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">interactiveScript</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>Look for a data-main script attribute, which could also adjust the baseUrl.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isBrowser</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>Figure out baseUrl. Get it from the script tag with require.js in it.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">eachReverse</span><span class="p">(</span><span class="nx">scripts</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>Set the 'head' where we can append children by
using the script's parent.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">head</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">head</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
            <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>Look for a data-main attribute to set main script for the page
to load. If it is there, the path to data main becomes the
baseUrl, if it is not already set.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">dataMain</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-main&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dataMain</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>Set final baseUrl if there is not already an explicit one.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>Pull off the directory of data-main for use as the
baseUrl.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="nx">src</span> <span class="o">=</span> <span class="nx">dataMain</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                    <span class="nx">mainScript</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                    <span class="nx">subPath</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">src</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="s1">&#39;./&#39;</span><span class="p">;</span>

                    <span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">=</span> <span class="nx">subPath</span><span class="p">;</span>
                    <span class="nx">dataMain</span> <span class="o">=</span> <span class="nx">mainScript</span><span class="p">;</span>
                <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>Strip off any trailing .js since dataMain is now
like a module name.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">dataMain</span> <span class="o">=</span> <span class="nx">dataMain</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">jsSuffixRegExp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>Put the data-main script in the files to load.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span> <span class="o">?</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">dataMain</span><span class="p">)</span> <span class="o">:</span> <span class="p">[</span><span class="nx">dataMain</span><span class="p">];</span>

                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * The function that handles definitions of modules. Differs from</span>
<span class="cm">     * require() in that a string for the module should be the first argument,</span>
<span class="cm">     * and the function to execute after dependencies are loaded should</span>
<span class="cm">     * return a value to define the module corresponding to the first argument&#39;s</span>
<span class="cm">     * name.</span>
<span class="cm">     */</span>
    <span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Allow for anonymous modules</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Adjust args appropriately</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">callback</span> <span class="o">=</span> <span class="nx">deps</span><span class="p">;</span>
            <span class="nx">deps</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>This module may not have dependencies</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">deps</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">callback</span> <span class="o">=</span> <span class="nx">deps</span><span class="p">;</span>
            <span class="nx">deps</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>If no name, and callback is a function, then figure out if it a
CommonJS thing with dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">deps</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
</pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>Remove comments from the callback string,
look for require calls, and pull them into the dependencies,
but only if there are function args.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span>
                    <span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
                    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">commentRegExp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">cjsRequireRegExp</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep</span><span class="p">);</span>
                    <span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>May be a CommonJS thing even without require calls, but still
could use exports, and module. Avoid doing exports and module
work though if it just needs require.
REQUIRES the function to expect the CommonJS variables in the
order listed below.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">deps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">?</span> <span class="p">[</span><span class="s1">&#39;require&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;exports&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">]).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>If in IE 6-8 and hit an anonymous define() call, do the interactive
work.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">useInteractive</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span> <span class="o">=</span> <span class="nx">currentlyAddingScript</span> <span class="o">||</span> <span class="nx">getInteractiveScript</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requiremodule&#39;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">context</span> <span class="o">=</span> <span class="nx">contexts</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requirecontext&#39;</span><span class="p">)];</span>
            <span class="p">}</span>
        <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>Always save off evaluating the def call until the script onload handler.
This allows multiple modules to be in a file without prematurely
tracing dependencies, and allows for anonymous module support,
where the module name is not known until the script onload event
occurs. If no context, use the global queue, and get it processed
in the onscript load callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="p">(</span><span class="nx">context</span> <span class="o">?</span> <span class="nx">context</span><span class="p">.</span><span class="nx">defQueue</span> <span class="o">:</span> <span class="nx">globalDefQueue</span><span class="p">).</span><span class="nx">push</span><span class="p">([</span><span class="nx">name</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">]);</span>
    <span class="p">};</span>

    <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">jQuery</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Executes the text. Normally just uses eval, but can be modified</span>
<span class="cm">     * to use a better, environment-specific call. Only used for transpiling</span>
<span class="cm">     * loader plugins, not for plain JS modules.</span>
<span class="cm">     * @param {String} text the text to execute/evaluate.</span>
<span class="cm">     */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">exec</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*jslint evil: true */</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">};</span>

</pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Set up with config info.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">req</span><span class="p">(</span><span class="nx">cfg</span><span class="p">);</span>
<span class="p">}(</span><span class="k">this</span><span class="p">));</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 